name: Build and Deploy React App

on:
  push:
    branches: [master]

permissions:
  contents: write
  packages: write # æ–°å¢ï¼šå…è®¸æœºå™¨äººä¸Šä¼  Docker é•œåƒåˆ° GitHub Packages

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Setup Node.js âš™ï¸
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install Dependencies ğŸ“¦
        run: npm install

      - name: Code Linting âœ¨
        run: npm run lint

      - name: Run Tests ğŸ§ª
        run: npm run test

      - name: Build ğŸ”§
        run: npm run build
        env:
          MY_API_KEY: ${{ secrets.MY_API_KEY }}

      - name: Deploy to GitHub Pages ğŸš€
        if: success()
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages

  # ================= æ–°å¢ï¼šDocker é•œåƒæ„å»ºä»»åŠ¡ =================
  build-docker-image:
    needs: build-and-deploy # åªæœ‰æµ‹è¯•å’Œç½‘é¡µéƒ¨ç½²æˆåŠŸäº†ï¼Œæ‰æ‰“é•œåƒ
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry ğŸ”‘
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image ğŸš€
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # é•œåƒåå­—æ ¼å¼ï¼šghcr.io/ç”¨æˆ·å/ä»“åº“å:latest
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest